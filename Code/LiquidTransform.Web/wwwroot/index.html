<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
  <meta charset="utf-8" />
  <title>Liquid Transform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet" crossorigin="anonymous" />

  <!-- JetBrains Mono -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet"/>

  <!-- highlight.js dark GitHub theme -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />

  <!-- CodeMirror core + theme + folding gutters -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css"/>

  <style>
    :root {
      --bg-start:#9fb3ff; --bg-end:#bdcadc; --card-bg:#1f2a33; --card-fg:#d6e1ff;
      --cmt:#6c7a89; --header-bg:#2e7d32;
    }
    body {
      background: radial-gradient(circle at 25% 10%, var(--bg-start), var(--bg-end));
      font-family: "JetBrains Mono", monospace;
      color: var(--card-fg);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 3rem 0;
    }
    .card {
      background: var(--card-bg);
      box-shadow: 0 10px 25px rgba(31,42,51,.6);
      border-radius: 1rem;
      padding: 2rem;
      width: 95%;
      max-width: 680px;
      max-height: calc(100vh - 2rem);
      overflow: auto;
    }
    h2 { color: var(--card-fg); }
    label.form-label { color: var(--cmt); }
    .btn-primary {
      background: #556cff;
      border-color: #556cff;
    }
    .btn-primary:hover {
      background: #4055ff;
      border-color: #4055ff;
    }
    #out {
      max-height: 45vh;
      overflow: auto;
    }
    #copy.copied {
      transform: scale(1.1);
      background-color: #198754 !important;
      border-color: #198754 !important;
      color: white;
      transition: all 0.3s ease;
    }
    pre, table {
      max-width: 100%;
      overflow-x: auto;
    }
    .CodeMirror {
      background: var(--card-bg) !important;
      color: var(--card-fg) !important;
    }
    .CodeMirror-gutters {
      background: var(--card-bg) !important;
      border-right: 0;
    }
    .CodeMirror-foldgutter { width: .8rem; }
    table.table-dark thead th {
      background-color: var(--header-bg) !important;
      color: #fff !important;
      position: sticky;
      top: 0;
      z-index: 1;
    }
  </style>
</head>
<body>
<div class="card">
  <h2 class="text-center mb-4">Liquid Transform</h2>

  <form id="form" class="vstack gap-3">
    <div>
      <label class="form-label" for="tpl">Template (.liquid)</label>
      <input class="form-control" id="tpl" type="file" accept=".liquid" required />
    </div>
    <div>
      <label class="form-label" for="src">Content (.json / .xml / .html / .yaml / .csv)</label>
      <input class="form-control" id="src" type="file"
             accept=".json,.xml,.html,.yaml,.yml,.csv" required />
    </div>
    <button class="btn btn-primary w-100" type="submit">Transform</button>
  </form>

  <div id="treeBtns" class="d-flex gap-2 mt-3 d-none">
    <button id="expand" class="btn btn-sm btn-outline-light">Expand all</button>
    <button id="collapse" class="btn btn-sm btn-outline-light">Collapse all</button>
    <a      id="download" class="btn btn-sm btn-outline-light" href="#" download>Download</a>
    <button id="copy" class="btn btn-sm btn-outline-light">Copy</button>
  </div>

  <div id="out" class="mt-3"></div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/yaml/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldall.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/yaml@2.7.1/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const form     = document.getElementById('form');
const out      = document.getElementById('out');
const btns     = document.getElementById('treeBtns');
const expand   = document.getElementById('expand');
const collapse = document.getElementById('collapse');
const download = document.getElementById('download');
const copy     = document.getElementById('copy');
let cm = null, latest = '';

form.addEventListener('submit', async e => {
  e.preventDefault();
  btns.classList.add('d-none');
  if (cm) { cm.toTextArea(); cm = null; }
  out.textContent = 'Running…';

  const tpl = document.getElementById('tpl').files[0];
  const src = document.getElementById('src').files[0];
  if (!tpl || !src) { alert('Both files required'); out.textContent = ''; return; }

  const fd = new FormData(); fd.append('template', tpl); fd.append('content', src);
  try {
    const r   = await fetch('/api/transform', { method: 'POST', body: fd });
    const txt = await r.text();
    if (!r.ok) throw txt;
    render(txt);
  } catch (err) {
    out.textContent = '❌ ' + err;
  }
});

function render(t) {
  latest = t;
  out.innerHTML = '';
  if (!(showJson(t) || showYaml(t) || showCsv(t) || showXml(t))) {
    out.innerHTML = `<pre class="p-3 bg-dark rounded text-light">${escapeHtml(t)}</pre>`;
  }

  const [mime, ext] = mimeOf(t);
  const blob = new Blob([t], { type: mime });
  download.href = URL.createObjectURL(blob);
  download.download = `result.${ext}`;

  copy.onclick = async () => {
    try {
      await navigator.clipboard.writeText(latest);
    } catch {
      const ta = Object.assign(document.createElement('textarea'), { value: latest });
      document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    }
    copy.classList.add('copied');
    setTimeout(() => copy.classList.remove('copied'), 800);
  };

  btns.classList.remove('d-none');
}

function mimeOf(s){
  if (showJson(s,true)) return ['application/json','json'];
  if (showYaml(s,true)) return ['text/yaml','yaml'];
  if (showCsv (s,true)) return ['text/csv','csv'];
  if (showXml (s,true)) return ['application/xml','xml'];
  return ['text/plain','txt'];
}

function mount(v, mode){
  out.innerHTML = '<textarea id="viewer"></textarea>';

  const foldOptions = {
    javascript: ['brace-fold', 'indent-fold'],
    yaml:       ['indent-fold'],
    xml:        ['xml-fold']
  };

  cm = CodeMirror.fromTextArea(document.getElementById('viewer'), {
    value: v,
    mode,
    theme: 'dracula',
    readOnly: true,
    lineNumbers: true,
    foldGutter: true,
    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter']
  });
  cm.setValue(v);
  expand.onclick   = () => cm.execCommand('unfoldAll');
  collapse.onclick = () => cm.execCommand('foldAll');
  btns.classList.remove('d-none');
}

function showJson(t, checkOnly=false){
  try { const obj = JSON.parse(t); if (checkOnly) return true;
        mount(JSON.stringify(obj,null,2), {name:'javascript',json:true}); return true;
  } catch { return false; }
}

function showYaml(t, checkOnly=false){
  try { if (checkOnly) { YAML.parse(t); return true; }
        mount(t, 'yaml'); return true;
  } catch { return false; }
}

function sanitizeHeader(h){ return h.trim().replace(/[^\w\s]/g,'').replace(/\s+/g,'_'); }

function showCsv(t, checkOnly=false){
  const result = Papa.parse(t,{header:true,skipEmptyLines:true,escapeChar:'\\',transformHeader:sanitizeHeader});
  if(checkOnly) return !(result.data.length===0||Object.keys(result.data[0]).length===0);
  if(result.data.length===0||Object.keys(result.data[0]).length===0) return false;

  const tbl = document.createElement('table');
  tbl.className='table table-bordered table-dark table-striped';
  const thead = tbl.createTHead(); const hdr = thead.insertRow();
  Object.keys(result.data[0]).forEach(k=>{ const th=document.createElement('th'); th.textContent=k; hdr.appendChild(th); });
  const tbody = tbl.createTBody();
  result.data.forEach(r=>{ const tr=tbody.insertRow(); Object.values(r).forEach(v=>{ const td=tr.insertCell(); td.textContent=v; });});
  out.textContent=''; out.appendChild(tbl); return true;
}

function showXml(t, checkOnly=false){
  const doc = new DOMParser().parseFromString(t,'application/xml');
  if(doc.getElementsByTagName('parsererror').length) return false;
  if(checkOnly) return true;
  const pretty = t.replace(/>\s*</g,'>\n<');
  mount(pretty, 'xml');
  return true;
}

function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
</script>
</body>
</html>
